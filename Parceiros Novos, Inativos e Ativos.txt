-------------------------NUNCA COMPRARAM, POR REGIÃO
SELECT (SELECT REG.NOMEREG FROM TSIREG REG WHERE REG.CODREG = P.AD_REGIAODISTRIBUICAO) AS REGIAO
    , COUNT(DISTINCT P.CODPARC) AS TOTAL
     
FROM TGFPAR P 
WHERE (SELECT COUNT(*) 
        FROM TGFCAB CAB 
        WHERE CAB.CODPARC = P.CODPARC
            AND CAB.CODTIPOPER IN (3210,3200, 3215)
            ) = 0
    AND P.CODTIPPARC = 10403000
GROUP BY P.AD_REGIAODISTRIBUICAO;

-------------------------INATIVOS, POR REGIÃO (A MAIS DE 90 DIAS)
SELECT (SELECT REG.NOMEREG FROM TSIREG REG WHERE REG.CODREG = P.AD_REGIAODISTRIBUICAO) AS REGIAO
    , COUNT(DISTINCT P.CODPARC) AS TOTAL
--DISTINCT ABC,AD_REGIAODISTRIBUICAO
--    , (SELECT REG.NOMEREG FROM TSIREG REG WHERE REG.CODREG = P.AD_REGIAODISTRIBUICAO) AS REGIAO
--    , count(AD_REGIAODISTRIBUICAO)

FROM TGFPAR P --INNER JOIN AD_CURVAABCPARCEIROS AD ON (P.CODPARC=AD.CODPARC)
WHERE (CASE WHEN (SELECT COUNT(1) 
        FROM TGFCAB CAB 
        WHERE CAB.CODPARC = P.CODPARC
            AND CAB.CODTIPOPER IN (3200, 3210)
            AND CAB.STATUSNFE = 'A') <> 0 THEN (SELECT MAX(CAB.DTFATUR) 
                                            FROM TGFCAB CAB 
                                            WHERE CAB.CODPARC = P.CODPARC
                                                AND CAB.CODTIPOPER IN (3200, 3210)
                                                AND CAB.STATUSNFE = 'A') ELSE SYSDATE + 10 END) < SYSDATE - 90
     AND P.CODTIPPARC = 10403000
     --AND AD_REGIAODISTRIBUICAO is not null
     --AND AD.NOVENTA = 'S'
     --AND AD_REGIAODISTRIBUICAO = 2020100
     group by P.AD_REGIAODISTRIBUICAO
     --ORDER BY 2,1;
	 
-------------------------ATIVOS (DENTRO DE 90 DIAS)

SELECT (SELECT REG.NOMEREG FROM TSIREG REG WHERE REG.CODREG = P.AD_REGIAODISTRIBUICAO) AS REGIAO
    , COUNT(DISTINCT P.CODPARC) AS TOTAL
FROM TGFPAR p
WHERE (CASE WHEN (SELECT COUNT(1) 
        FROM TGFCAB CAB 
        WHERE CAB.CODPARC = P.CODPARC
            AND CAB.CODTIPOPER IN (3200, 3210, 3215)
            AND CAB.STATUSNFE = 'A') <> 0 THEN (SELECT MAX(CAB.DTFATUR) 
                                            FROM TGFCAB CAB 
                                            WHERE CAB.CODPARC = P.CODPARC
                                                AND CAB.CODTIPOPER IN (3200, 3210)
                                                AND CAB.STATUSNFE = 'A'
                                                AND CAB.DTFATUR BETWEEN (SYSDATE - 90) AND SYSDATE) ELSE SYSDATE + 1 END) < SYSDATE
GROUP BY P.AD_REGIAODISTRIBUICAO